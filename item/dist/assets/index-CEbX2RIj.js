import{E as q,T as y,r as p,H as U,U as ae,L as Y,V as ie,W as oe,w as D,_ as le,b as N,o as re,c as ue,f as d,g,k as I,P as de,h as ce,e as he,x as fe}from"./index-Dom6VubR.js";import ge from"./Item-DEL-HGZ9.js";const _={FRONT:"FRONT",BEHIND:"BEHIND"},E={INIT:"INIT",FIXED:"FIXED",DYNAMIC:"DYNAMIC"},$=0;class pe{constructor(e,s){this.init(e,s)}init(e,s){this.param=e,this.callUpdate=s,this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.fixedSizeValue=0,this.calcType=E.INIT,this.offset=0,this.direction="",this.range=Object.create(null),e&&this.checkRange(0,e.keeps-1)}destroy(){this.init(null,null)}getRange(){const e=Object.create(null);return e.start=this.range.start,e.end=this.range.end,e.padFront=this.range.padFront,e.padBehind=this.range.padBehind,e}isBehind(){return this.direction===_.BEHIND}isFront(){return this.direction===_.FRONT}getOffset(e){return(e<1?0:this.getIndexOffset(e))+this.param.slotHeaderSize}updateParam(e,s){this.param&&e in this.param&&(e==="uniqueIds"&&this.sizes.forEach((i,a)=>{s.includes(a)||this.sizes.delete(a)}),this.param[e]=s)}saveSize(e,s){this.sizes.set(e,s),this.calcType===E.INIT?(this.fixedSizeValue=s,this.calcType=E.FIXED):this.calcType===E.FIXED&&this.fixedSizeValue!==s&&(this.calcType=E.DYNAMIC,delete this.fixedSizeValue),this.calcType!==E.FIXED&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=[...this.sizes.values()].reduce((i,a)=>i+a,0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):delete this.firstRangeTotalSize)}handleDataSourcesChange(){let e=this.range.start;this.isFront()?e=e-$:this.isBehind()&&(e=e+$),e=Math.max(e,0),this.updateRange(this.range.start,this.getEndByStart(e))}handleSlotSizeChange(){this.handleDataSourcesChange()}handleScroll(e){this.direction=e<this.offset||e===0?_.FRONT:_.BEHIND,this.offset=e,this.param&&(this.direction===_.FRONT?this.handleFront():this.direction===_.BEHIND&&this.handleBehind())}handleFront(){const e=this.getScrollOvers();if(e>this.range.start)return;const s=Math.max(e-this.param.buffer,0);this.checkRange(s,this.getEndByStart(s))}handleBehind(){const e=this.getScrollOvers();e<this.range.start+this.param.buffer||this.checkRange(e,this.getEndByStart(e))}getScrollOvers(){const e=this.offset-this.param.slotHeaderSize;if(e<=0)return 0;if(this.isFixedType())return Math.floor(e/this.fixedSizeValue);let s=0,i=0,a=0,u=this.param.uniqueIds.length;for(;s<=u;){if(i=s+Math.floor((u-s)/2),a=this.getIndexOffset(i),a===e)return i;a<e?s=i+1:a>e&&(u=i-1)}return s>0?--s:0}getIndexOffset(e){if(!e)return 0;let s=0,i=0;for(let a=0;a<e;a++)i=this.sizes.get(this.param.uniqueIds[a]),s=s+(typeof i=="number"?i:this.getEstimateSize());return s}isFixedType(){return this.calcType===E.FIXED}getLastIndex(){return this.param.uniqueIds.length-1}checkRange(e,s){const i=this.param.keeps;this.param.uniqueIds.length<=i?(e=0,s=this.getLastIndex()):s-e<i-1&&(e=s-i+1),this.range.start!==e&&this.updateRange(e,s)}updateRange(e,s){this.range.start=e,this.range.end=s,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())}getEndByStart(e){const s=e+this.param.keeps-1;return Math.min(s,this.getLastIndex())}getPadFront(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}getPadBehind(){const e=this.range.end,s=this.getLastIndex();return this.isFixedType()?(s-e)*this.fixedSizeValue:(s-e)*this.getEstimateSize()}getEstimateSize(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}}const me={dataKey:{type:[String,Function],required:!0},dataSources:{type:Array,required:!0},dataComponent:{type:[Object,Function],required:!0},keeps:{type:Number,default:30},extraProps:{type:Object},estimateSize:{type:Number,default:50},direction:{type:String,default:"vertical"},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0},pageMode:{type:Boolean,default:!1},rootTag:{type:String,default:"div"},wrapTag:{type:String,default:"div"},wrapClass:{type:String,default:""},wrapStyle:{type:Object},itemTag:{type:String,default:"div"},itemClass:{type:String,default:""},itemClassAdd:{type:Function},itemStyle:{type:Object},headerTag:{type:String,default:"div"},headerClass:{type:String,default:""},headerStyle:{type:Object},footerTag:{type:String,default:"div"},footerClass:{type:String,default:""},footerStyle:{type:Object},itemScopedSlots:{type:Object}},ve={index:{type:Number},event:{type:String},tag:{type:String},horizontal:{type:Boolean},source:{type:Object},component:{type:[Object,Function]},slotComponent:{type:Function},uniqueKey:{type:[String,Number]},extraProps:{type:Object},scopedSlots:{type:Object}},ye={event:{type:String},uniqueKey:{type:String},tag:{type:String},horizontal:{type:Boolean}},X=(n,e)=>{const s=p(n.horizontal?"offsetWidth":"offsetHeight"),i=p(null),a=p(null),u=()=>a.value?a.value[s.value]:0,o=()=>{e(n.event,n.uniqueKey,u(),n.hasInitial)};return U(()=>{typeof ResizeObserver<"u"&&(i.value=new ResizeObserver(()=>{o()}),a.value&&i.value.observe(a.value))}),ae(()=>{i.value&&a.value&&i.value.observe(a.value)}),Y(()=>{i.value&&(i.value.disconnect(),i.value=null)}),{element:a,getCurrentSize:u,dispatchSizeChange:o}},Se=q({name:"VirtualListItem",props:{...ve,tag:{type:String,default:"div"},horizontal:Boolean,uniqueKey:[String,Number],event:String,hasInitial:Boolean,component:[String,Object],extraProps:Object,index:Number,source:[Object,Number,String],scopedSlots:Object,slotComponent:Function},emits:["item-size-change"],setup(n,{emit:e}){const{element:s}=X(n,e);return{element:s}},render(){const{tag:n,component:e,extraProps:s={},index:i,source:a,uniqueKey:u,slotComponent:o}=this,r={...s,source:a,index:i};return y(n,{key:u,ref:"element",role:"listitem"},[this.slotComponent?this.slotComponent({item:a,index:i,scope:r}):y(e,r,this.$slots.default)])}}),A=q({name:"VirtualListSlot",props:{...ye,tag:{type:String,default:"div"},horizontal:Boolean,uniqueKey:[String,Number],event:String,hasInitial:Boolean},emits:["slot-size-change"],setup(n,{emit:e}){const{element:s}=X(n,e);return{element:s}},render(){var s,i;const{tag:n,uniqueKey:e}=this;return y(n,{key:e,ref:"element",role:e},(i=(s=this.$slots).default)==null?void 0:i.call(s))}}),V={ITEM:"item_resize",SLOT:"slot_resize"},K={HEADER:"thead",FOOTER:"tfoot"},ze=q({name:"VirtualList",props:me,emits:["resized","scroll","totop","tobottom"],setup(n,{emit:e,slots:s}){const i=p(null),a=p(null),u=p(null),o=p(null),r=p(n.direction==="horizontal"),c=p(r.value?"scrollLeft":"scrollTop"),S=()=>{const{dataKey:t}=n;return n.dataSources.map(l=>typeof t=="function"?t(l):l[t])},F=t=>{var l;return(l=o.value)==null?void 0:l.sizes.get(t)},z=()=>{var t;return(t=o.value)==null?void 0:t.sizes.size},T=()=>n.pageMode?document.documentElement[c.value]||document.body[c.value]:a.value?Math.ceil(a.value[c.value]):0,h=()=>{const t=r.value?"clientWidth":"clientHeight";return n.pageMode?document.documentElement[t]||document.body[t]:a.value?Math.ceil(a.value[t]):0},x=()=>{const t=r.value?"scrollWidth":"scrollHeight";return n.pageMode?document.documentElement[t]||document.body[t]:a.value?Math.ceil(a.value[t]):0},f=t=>{n.pageMode?(document.body[c.value]=t,document.documentElement[c.value]=t):a.value&&(a.value[c.value]=t)},O=t=>{if(t>=n.dataSources.length-1)R();else{const l=o.value.getOffset(t);f(l)}},R=()=>{if(u.value){const t=u.value[r.value?"offsetLeft":"offsetTop"];f(t),setTimeout(()=>{T()+h()+1<x()&&R()},3)}},P=()=>{if(a.value){const t=a.value.getBoundingClientRect(),{defaultView:l}=a.value.ownerDocument,m=r.value?t.left+l.pageXOffset:t.top+l.pageYOffset;o.value.updateParam("slotHeaderSize",m)}},W=()=>{var t;(t=o.value)==null||t.destroy(),f(0),j()},j=()=>{o.value=new pe({slotHeaderSize:0,slotFooterSize:0,keeps:n.keeps,estimateSize:n.estimateSize,buffer:Math.round(n.keeps/3),uniqueIds:S()},G),i.value=o.value.getRange()},G=t=>{i.value=t},B=t=>{var v;const l=T(),m=h(),b=x();l<0||l+m>b+1||!b||((v=o.value)==null||v.handleScroll(l),J(l,m,b,t))},J=(t,l,m,b)=>{var v,M,k;e("scroll",b,(v=o.value)==null?void 0:v.getRange()),(M=o.value)!=null&&M.isFront()&&n.dataSources.length&&t-n.topThreshold<=0?e("totop"):(k=o.value)!=null&&k.isBehind()&&t+l+n.bottomThreshold>=m&&e("tobottom")},Q=()=>{const t=[];if(!i.value)return t;const{start:l,end:m}=i.value,{dataSources:b,dataKey:v,itemClass:M,itemTag:k,itemStyle:Z,extraProps:ee,dataComponent:te,itemScopedSlots:se,itemClassAdd:H}=n,ne=s.item;for(let C=l;C<=m;C++){const L=b[C];if(L){const w=typeof v=="function"?v(L):L[v];typeof w=="string"||typeof w=="number"?t.push(y(Se,{index:C,tag:k,event:V.ITEM,horizontal:r.value,uniqueKey:w,source:L,extraProps:ee,component:te,slotComponent:ne,scopedSlots:se,style:Z,class:`${M}${H?" "+H(C):""}`})):console.warn(`Cannot get the data-key '${v}' from data-sources.`)}else console.warn(`Cannot get the index '${C}' from data-sources.`)}return t};return U(()=>{n.start?O(n.start):n.offset&&f(n.offset),n.pageMode&&(P(),document.addEventListener("scroll",B,{passive:!1}))}),ie(()=>{var t;f(((t=o.value)==null?void 0:t.offset)||0),n.pageMode&&document.addEventListener("scroll",B,{passive:!1})}),oe(()=>{n.pageMode&&document.removeEventListener("scroll",B)}),Y(()=>{var t;(t=o.value)==null||t.destroy(),n.pageMode&&document.removeEventListener("scroll",B)}),D(()=>n.dataSources.length,()=>{var t,l;(t=o.value)==null||t.updateParam("uniqueIds",S()),(l=o.value)==null||l.handleDataSourcesChange()}),D(()=>n.keeps,t=>{var l,m;(l=o.value)==null||l.updateParam("keeps",t),(m=o.value)==null||m.handleSlotSizeChange()}),D(()=>n.start,t=>{O(t)}),D(()=>n.offset,t=>{f(t)}),j(),{root:a,shepherd:u,range:i,isHorizontal:r,getRenderSlots:Q,onScroll:B,reset:W,scrollToBottom:R,scrollToIndex:O,scrollToOffset:f,getSize:F,getSizes:z,getOffset:T,getClientSize:h,getScrollSize:x,updatePageModeFront:P}},render(){const{isHorizontal:n,pageMode:e,rootTag:s,wrapTag:i,wrapClass:a,wrapStyle:u,headerTag:o,headerClass:r,headerStyle:c,footerTag:S,footerClass:F,footerStyle:z}=this.$props,{header:T,footer:h}=this.$slots,{padFront:x,padBehind:f}=this.range||{padFront:0,padBehind:0},O={padding:n?`0px ${f}px 0px ${x}px`:`${x}px 0px ${f}px`},R=u?Object.assign({},u,O):O;return y(s,{ref:"root",onScroll:e?null:this.onScroll},[T?y(A,{class:r,style:c,tag:o,event:V.SLOT,uniqueKey:K.HEADER,onSlotResize:this.onSlotResized},T()):null,y(i,{class:a,role:"group",style:R},this.getRenderSlots()),h?y(A,{class:F,style:z,tag:S,event:V.SLOT,uniqueKey:K.FOOTER,onSlotResize:this.onSlotResized},h()):null,y("div",{ref:"shepherd",style:{width:n?"0px":"100%",height:n?"100%":"0px"}})])}}),Te={class:"app-container"},xe={class:"operation"},Ie={__name:"index",setup(n){const e=p(null),s=p(!1),i=()=>Array.from({length:500},(o,r)=>({id:Math.random().toString(36).substring(2,10),name:`列表name${r+1}`})),a=p(i()),u=()=>{a.value=[...a.value,...i()],e.value.scrollToBottom()};return(o,r)=>{const c=N("el-text"),S=N("el-divider"),F=N("el-switch"),z=N("el-button"),T=N("el-space");return re(),ue("div",Te,[d(ce(ze),{class:de(["virtual-List",{"smooth-scroll":s.value}]),"data-key":"id","data-sources":a.value,ref_key:"virtualListRef",ref:e},{header:g(()=>[d(c,{type:"primary"},{default:g(()=>[I("我是头部插槽header")]),_:1})]),item:g(({item:h,index:x,scope:f})=>[d(ge,{item:h,index:x,scope:f},null,8,["item","index","scope"])]),footer:g(()=>[d(c,{type:"success"},{default:g(()=>[I("我是底部插槽footer")]),_:1})]),_:1},8,["class","data-sources"]),he("div",xe,[d(c,{type:"primary",size:"large"},{default:g(()=>[I("当前数据量："+fe(a.value.length)+" 条",1)]),_:1}),d(S),d(F,{modelValue:s.value,"onUpdate:modelValue":r[0]||(r[0]=h=>s.value=h),size:"large","active-text":"开启滚动过度效果","inactive-text":"关闭滚动过度效果"},null,8,["modelValue"]),d(S),d(T,{size:50},{default:g(()=>[d(z,{type:"primary",onClick:u},{default:g(()=>[I("新增500条数据")]),_:1}),d(z,{type:"success",onClick:r[1]||(r[1]=h=>e.value.scrollToIndex(100))},{default:g(()=>[I("滚动到第100条位置")]),_:1}),d(z,{type:"warning",onClick:r[2]||(r[2]=h=>e.value.scrollToBottom())},{default:g(()=>[I("滚动到底部")]),_:1}),d(z,{type:"danger",onClick:r[3]||(r[3]=h=>e.value.scrollToIndex(0))},{default:g(()=>[I("滚动到顶部")]),_:1})]),_:1}),d(S),d(c,{type:"success",size:"large"},{default:g(()=>[I("更多使用说明请查看@/utils/virtualList/使用说明.md文件")]),_:1})])])}}},Oe=le(Ie,[["__scopeId","data-v-0ec98977"]]);export{Oe as default};
